name: Code Quality Badges

on:
  push:
    branches: [main]
    paths:
      - 'orchard/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/badges.yml'
  workflow_dispatch:

jobs:
  badges:
    name: Update Quality Badges
    runs-on: ubuntu-latest
    env:
      GIST_AUTH: "${{ secrets.GIST_SECRET }}"
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install package and tools
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test]"
          pip install black ruff mypy radon bandit types-PyYAML types-requests

      # --- Black ---
      - name: Run Black
        id: black
        run: |
          if black --check --quiet . 2>/dev/null; then
            echo "status=passing" >> "$GITHUB_OUTPUT"
            echo "color=000000" >> "$GITHUB_OUTPUT"
          else
            echo "status=failing" >> "$GITHUB_OUTPUT"
            echo "color=e74c3c" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Black badge
        uses: schneegans/dynamic-badges-action@e9a478b16159b4d31420099ba146cdc50f134483  # v1.7.0
        with:
          auth: "${{ env.GIST_AUTH }}"
          gistID: "7835190af6011e9051b673c8be974f8a"
          filename: black.json
          label: black
          message: "${{ steps.black.outputs.status }}"
          color: "${{ steps.black.outputs.color }}"
          namedLogo: python
          logoColor: white

      # --- Ruff ---
      - name: Run Ruff
        id: ruff
        run: |
          if ruff check orchard/ tests/ 2>/dev/null; then
            echo "status=passing" >> "$GITHUB_OUTPUT"
            echo "color=d4aa00" >> "$GITHUB_OUTPUT"
          else
            echo "status=failing" >> "$GITHUB_OUTPUT"
            echo "color=e74c3c" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Ruff badge
        uses: schneegans/dynamic-badges-action@e9a478b16159b4d31420099ba146cdc50f134483  # v1.7.0
        with:
          auth: "${{ env.GIST_AUTH }}"
          gistID: "7835190af6011e9051b673c8be974f8a"
          filename: ruff.json
          label: ruff
          message: "${{ steps.ruff.outputs.status }}"
          color: "${{ steps.ruff.outputs.color }}"
          namedLogo: python
          logoColor: white

      # --- mypy ---
      - name: Run mypy
        id: mypy
        run: |
          if mypy orchard/ 2>/dev/null; then
            echo "status=passing" >> "$GITHUB_OUTPUT"
            echo "color=2a6db2" >> "$GITHUB_OUTPUT"
          else
            echo "status=failing" >> "$GITHUB_OUTPUT"
            echo "color=e74c3c" >> "$GITHUB_OUTPUT"
          fi

      - name: Update mypy badge
        uses: schneegans/dynamic-badges-action@e9a478b16159b4d31420099ba146cdc50f134483  # v1.7.0
        with:
          auth: "${{ env.GIST_AUTH }}"
          gistID: "7835190af6011e9051b673c8be974f8a"
          filename: mypy.json
          label: mypy
          message: "${{ steps.mypy.outputs.status }}"
          color: "${{ steps.mypy.outputs.color }}"
          namedLogo: python
          logoColor: white

      # --- Bandit ---
      - name: Run Bandit
        id: bandit
        run: |
          if bandit -r orchard/ -l -q 2>/dev/null; then
            echo "status=passing" >> "$GITHUB_OUTPUT"
            echo "color=brightgreen" >> "$GITHUB_OUTPUT"
          else
            echo "status=failing" >> "$GITHUB_OUTPUT"
            echo "color=e74c3c" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Bandit badge
        uses: schneegans/dynamic-badges-action@e9a478b16159b4d31420099ba146cdc50f134483  # v1.7.0
        with:
          auth: "${{ env.GIST_AUTH }}"
          gistID: "7835190af6011e9051b673c8be974f8a"
          filename: bandit.json
          label: bandit
          message: "${{ steps.bandit.outputs.status }}"
          color: "${{ steps.bandit.outputs.color }}"
          namedLogo: python
          logoColor: white

      # --- Radon (cyclomatic complexity average) ---
      - name: Run Radon
        id: radon
        run: |
          # Extract average complexity from radon output
          AVG=$(radon cc orchard/ --total-average 2>/dev/null | tail -1 | grep -oP '[\d.]+' | tail -1)
          if [ -z "$AVG" ]; then
            echo "status=error" >> "$GITHUB_OUTPUT"
            echo "color=lightgrey" >> "$GITHUB_OUTPUT"
          else
            AVG=$(printf "%.2f" "$AVG")
            echo "status=A ($AVG)" >> "$GITHUB_OUTPUT"
            # Color based on grade: A (<= 5) green, B (<= 10) yellow, C+ red
            if awk "BEGIN {exit !($AVG <= 5)}"; then
              echo "color=brightgreen" >> "$GITHUB_OUTPUT"
            elif awk "BEGIN {exit !($AVG <= 10)}"; then
              echo "color=e5ae38" >> "$GITHUB_OUTPUT"
            else
              echo "color=e74c3c" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Update Radon badge
        uses: schneegans/dynamic-badges-action@e9a478b16159b4d31420099ba146cdc50f134483  # v1.7.0
        with:
          auth: "${{ env.GIST_AUTH }}"
          gistID: "7835190af6011e9051b673c8be974f8a"
          filename: radon.json
          label: radon
          message: "${{ steps.radon.outputs.status }}"
          color: "${{ steps.radon.outputs.color }}"

      # --- Test Count Badges ---
      - name: Collect test counts
        id: tests
        run: |
          TOTAL=$(python -m pytest tests/ --collect-only 2>&1 | grep -oP '^\d+(?= tests collected)')
          UNIT=$(python -m pytest tests/ -m unit --collect-only 2>&1 | grep -oP '^\d+(?=/)')
          INTEGRATION=$(python -m pytest tests/ -m integration --collect-only 2>&1 | grep -oP '^\d+(?=/)')
          echo "total=${TOTAL:-0}" >> "$GITHUB_OUTPUT"
          echo "unit=${UNIT:-0}" >> "$GITHUB_OUTPUT"
          echo "integration=${INTEGRATION:-0}" >> "$GITHUB_OUTPUT"

      - name: Update unit tests badge
        uses: schneegans/dynamic-badges-action@e9a478b16159b4d31420099ba146cdc50f134483  # v1.7.0
        with:
          auth: "${{ env.GIST_AUTH }}"
          gistID: "7835190af6011e9051b673c8be974f8a"
          filename: tests_unit.json
          label: unit tests
          message: "${{ steps.tests.outputs.unit }}"
          color: "2b7489"
          namedLogo: pytest
          logoColor: white

      - name: Update integration tests badge
        uses: schneegans/dynamic-badges-action@e9a478b16159b4d31420099ba146cdc50f134483  # v1.7.0
        with:
          auth: "${{ env.GIST_AUTH }}"
          gistID: "7835190af6011e9051b673c8be974f8a"
          filename: tests_integration.json
          label: integration tests
          message: "${{ steps.tests.outputs.integration }}"
          color: "1a7f37"
          namedLogo: pytest
          logoColor: white
